<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - den</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .welcome {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .welcome h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .welcome p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        .card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status.running {
            background: #d4edda;
            color: #155724;
        }
        
        .status.creating {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.none {
            background: #f8d7da;
            color: #721c24;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .button:hover {
            transform: translateY(-2px);
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.danger {
            background: #dc3545;
        }
        
        .container-info {
            margin: 1rem 0;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .subdomain-list {
            margin: 1rem 0;
        }
        
        .subdomain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .subdomain-url {
            font-family: monospace;
            color: #667eea;
            font-weight: 600;
        }
        
        .subdomain-type {
            font-size: 0.8rem;
            color: #888;
            background: #e0e0e0;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            margin-right: 0.5rem;
        }
        
        .subdomain-port {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.2rem;
        }
        
        .subdomain-form {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-group input[type="radio"] {
            margin-right: 0.5rem;
        }
        
        #subdomain-preview {
            display: block;
            color: #888;
            font-style: italic;
            margin-top: 0.3rem;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin: 1rem 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .ssh-command {
            background: #2d3748;
            color: #68d391;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            margin: 1rem 0;
        }
        .modal-backdrop { position:fixed; inset:0; background: rgba(0,0,0,0.35); display:none; }
        .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding: 1rem; z-index:1000; }
        .modal-content { background:#fff; width:100%; max-width:520px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,.15); padding:1.25rem; position:relative; }
        .modal h3 { margin: 0 0 .75rem 0; }
        .modal-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem; }
        .close { position:absolute; right:.75rem; top:.5rem; background:none; border:0; font-size:1.5rem; color:#666; cursor:pointer; }
        #toast-container { position: fixed; right: 1rem; bottom: 1rem; display:flex; flex-direction:column; gap:.5rem; z-index: 2000; }
        .toast { background:#111827; color:#fff; padding:.75rem 1rem; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.2); opacity:0.98; }
        .toast.success { background:#065f46; }
        .toast.error { background:#7f1d1d; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeModal()">&times;</button>
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
            <div class="modal-actions">
                <button class="button secondary" onclick="closeModal()">cancel</button>
                <button class="button" id="modal-confirm-btn">confirm</button>
            </div>
        </div>
    </div>
    <div class="header">
        <div class="logo">den</div>
        <div class="user-info">
            <span>{{.user.DisplayName}}</span>
            <span>({{.user.Username}})</span>
        </div>
    </div>
    
    <div class="container">
        <div class="welcome">
            <h1>welcome to your den, {{.user.DisplayName}}!</h1>
            <p>your cozy *nix system</p>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>status</h2>
                {{if .container}}
                    <div class="status running">running</div>
                    <div class="container-info">
                        <div class="info-row">
                            <span>container id:</span>
                            <span>{{.container.ID}}</span>
                        </div>
                        <div class="info-row">
                            <span>ip address:</span>
                            <span>{{.container.IPAddress}}</span>
                        </div>
                        <div class="info-row">
                            <span>memory:</span>
                            <span>{{.container.MemoryMB}}MB</span>
                        </div>
                        <div class="info-row">
                            <span>cpu cores:</span>
                            <span>{{.container.CPUCores}}</span>
                        </div>
                        <div class="info-row">
                            <span>storage:</span>
                            <span>{{.container.StorageGB}}GB</span>
                        </div>
                        <div class="info-row">
                            <span>allocated ports:</span>
                            <span>
                                {{if .container.AllocatedPorts}}
                                    {{range $index, $port := .container.AllocatedPorts}}{{if $index}}, {{end}}{{$port}}{{end}}
                                {{else}}
                                    none
                                {{end}}
                                {{if .container}}
                                    &nbsp; <button class="button secondary" onclick="getNewPort()">get new port</button>
                                {{end}}
                            </span>
                        </div>
                    </div>
                    
                    <div class="ssh-command">
                        ssh {{.user.Username}}@hack.kim
                    </div>
                    
                    <a href="/user/ssh-setup" class="button">configure ssh access</a>
                {{else}}
                    <div class="status none">no environment</div>
                    <p>you don't have an environment yet. create one to get started</p>
                    <br>
                    <button class="button" onclick="confirmCreateContainer()">Create Container</button>
                {{end}}
            </div>
            <div class="card">
                <h2>subdomains</h2>
                <div class="subdomain-list">
                    {{range .subdomains}}
                    <div class="subdomain-item">
                        <div>
                            {{if eq .SubdomainType "username"}}
                            <div class="subdomain-url">{{.Subdomain}}.hack.kim</div>
                            <span class="subdomain-type">username subdomain</span>
                            {{else}}
                            <div class="subdomain-url">{{.Subdomain}}.{{$.user.Username}}.hack.kim</div>
                            <span class="subdomain-type">project subdomain</span>
                            {{end}}
                            <div class="subdomain-port"> -> port {{.TargetPort}}</div>
                        </div>
                        <button class="button danger" onclick="confirmDeleteSubdomain('{{.ID}}')">delete</button>
                    </div>
                    {{else}}
                    <p>no subdomains configured yet.</p>
                    {{end}}
                </div>
                
                {{if .container}}
                <div class="subdomain-form">
                    <h3>create new subdomain</h3>
                    
                    <div class="form-group">
                        <label>subdomain type:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="subdomain_type" value="username" id="type-username"> username ({{.user.Username}}.hack.kim)</label>
                            <label><input type="radio" name="subdomain_type" value="project" id="type-project" checked> project (myapp.{{.user.Username}}.hack.kim)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="subdomain">subdomain name:</label>
                        <input type="text" id="subdomain" placeholder="myproject">
                        <small id="subdomain-preview">preview: myproject.{{.user.Username}}.hack.kim</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="port">target port (from your allocated ports):</label>
                        <select id="port">
                            <option value="">select a port</option>
                            {{range .container.AllocatedPorts}}
                            <option value="{{.}}">{{.}}</option>
                            {{end}}
                        </select>
                    </div>
                    
                    <button class="button" onclick="createSubdomain()">create subdomain</button>
                </div>
                {{else}}
                <p>create an environment first to manage subdomains</p>
                {{end}}
            </div>
        </div>
    </div>
    
    <script>
        function confirmCreateContainer() {
            openModal({
                title: 'create container',
                html: '<p>create your personal environment? this will take a few minutes.</p>',
                confirmText: 'create',
                onConfirm: () => {
                    fetch('/user/container/create', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                    .then(r => r.json())
                    .then(d => {
                        if (d.error) { showToast(d.error, 'error'); return; }
                        closeModal();
                        showToast('container creation started. refresh in a few minutes.', 'success');
                        location.reload();
                    })
                    .catch(e => showToast(String(e), 'error'));
                }
            });
        }
        
        function createSubdomain() {
            const subdomain = document.getElementById('subdomain').value;
            const port = parseInt(document.getElementById('port').value);
            const subdomainType = document.querySelector('input[name="subdomain_type"]:checked').value;
            
            if (!subdomain || !port) { showToast('please fill in both subdomain and port', 'error'); return; }
            
            if (subdomainType === 'username' && subdomain !== '{{.user.Username}}') {
                showToast('username subdomain must be your username: {{.user.Username}}', 'error'); return;
            }
            
            fetch('/user/subdomains', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subdomain: subdomain,
                    target_port: port,
                    subdomain_type: subdomainType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast('subdomain created', 'success');
                location.reload();
            })
            .catch(error => showToast(String(error), 'error'));
        }

        function getNewPort() {
            fetch('/user/container/ports/new', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) { showToast(data.error, 'error'); return; }
                showToast('allocated port: ' + data.port, 'success');
                const sel = document.getElementById('port');
                if (sel) {
                    const opt = document.createElement('option');
                    opt.value = data.port;
                    opt.textContent = data.port;
                    sel.appendChild(opt);
                }
                location.reload();
            })
            .catch(err => showToast(String(err), 'error'));
        }
        
        function updatePreview() {
            const subdomain = document.getElementById('subdomain').value || 'myproject';
            const subdomainType = document.querySelector('input[name="subdomain_type"]:checked').value;
            const preview = document.getElementById('subdomain-preview');
            
            if (subdomainType === 'username') {
                preview.textContent = 'preview: {{.user.Username}}.hack.kim';
                document.getElementById('subdomain').placeholder = '{{.user.Username}}';
            } else {
                preview.textContent = 'preview: ' + subdomain + '.{{.user.Username}}.hack.kim';
                document.getElementById('subdomain').placeholder = 'myproject';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('subdomain').addEventListener('input', updatePreview);
            document.querySelectorAll('input[name="subdomain_type"]').forEach(radio => {
                radio.addEventListener('change', updatePreview);
            });
            updatePreview();
        });
        
        function confirmDeleteSubdomain(id) {
            openModal({
                title: 'delete subdomain',
                html: '<p>are you sure you want to delete this subdomain?</p>',
                confirmText: 'delete',
                onConfirm: () => {
                    fetch('/user/subdomains/' + id, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(d => {
                        if (d.error) { showToast(d.error, 'error'); return; }
                        closeModal();
                        showToast('subdomain deleted', 'success');
                        location.reload();
                    })
                    .catch(e => showToast(String(e), 'error'));
                }
            });
        }
        let modalConfirmHandler = null;
        function openModal({ title, html, confirmText, onConfirm }) {
            document.getElementById('modal-title').textContent = title || '';
            document.getElementById('modal-body').innerHTML = html || '';
            const btn = document.getElementById('modal-confirm-btn');
            btn.textContent = confirmText || 'confirm';
            modalConfirmHandler = onConfirm || null;
            btn.onclick = function() { if (modalConfirmHandler) modalConfirmHandler(); };
            document.getElementById('modal-backdrop').style.display = 'block';
            document.getElementById('modal').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modal-backdrop').style.display = 'none';
            modalConfirmHandler = null;
        }
        function showToast(message, type) {
            const cont = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast' + (type ? ' ' + type : '');
            t.textContent = message;
            cont.appendChild(t);
            setTimeout(() => { t.remove(); }, 4000);
        }
    </script>
</body>
</html>
